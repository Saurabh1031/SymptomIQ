/*! For license information please see storage-writer.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["@bugfender/sdk"]=t():e["@bugfender/sdk"]=t()}(self,(()=>(()=>{"use strict";var e={};return{5041:function(e,t){var s=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(a,o){function d(e){try{n(i.next(e))}catch(e){o(e)}}function r(e){try{n(i.throw(e))}catch(e){o(e)}}function n(e){var t;e.done?a(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(d,r)}n((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.StorageWriter=void 0,t.StorageWriter=class{constructor(e,t,s,i){this.deviceKeysTable=e,this.issuesTable=t,this.logFactory=s,this.logsTable=i,this.isClearingSpace=!1,this.logsQueue=[]}handleMessage(e){return s(this,void 0,void 0,(function*(){switch(e.type){case"device-key":return this.addDeviceKey(e.data.key,e.data.value,e.data.callInfo,e.data.time);case"init":this.options=e.data.options,this.sessionUUID=e.data.sessionUUID;break;case"issue":return this.addIssue(e.data.type,e.data.title,e.data.text,e.data.uuid,e.data.callInfo,e.data.time);case"log-entry":return this.addLogEntry(e.data.log,e.data.callInfo,e.data.time)}}))}addDeviceKey(e,t,s,i){this.deviceKeysTable.add({sessionUUID:this.sessionUUID,data:{key:e,value:t}}),this.addLog(this.logFactory.createFromDeviceKey(e,t,s,i))}addLog(e){return s(this,void 0,void 0,(function*(){const t={sessionUUID:this.sessionUUID,data:e};if(this.isClearingSpace)this.logsQueue.push(t);else try{yield this.logsTable.add(t)}catch(e){this.isQuotaExceededError(e)&&(this.logsQueue.push(t),this.isClearingSpace=!0,yield this.logsTable.deleteOldLogs(this.sessionUUID),yield this.processLogsQueue(),this.isClearingSpace=!1)}}))}addLogEntry(e,t,s){this.addLog(this.logFactory.createFromEntry(e,t,s))}addIssue(e,t,s,i,a,o){this.issuesTable.add({sessionUUID:this.sessionUUID,data:{title:t,text:s,type:e,uuid:i}}),this.addLog(this.logFactory.createFromIssue(i,a,o))}isQuotaExceededError(e){var t;return"QuotaExceededError"===e.name||"QuotaExceededError"===(null===(t=e.inner)||void 0===t?void 0:t.name)}processLogsQueue(){return s(this,void 0,void 0,(function*(){for(;this.logsQueue.length>0;){const e=this.logsQueue[0];try{yield this.logsTable.add(e),this.logsQueue.shift()}catch(e){this.isQuotaExceededError(e)&&(yield this.logsTable.deleteOldLogs(this.sessionUUID))}}}))}}}}[5041](0,e),e})()));
//# sourceMappingURL=storage-writer.js.map