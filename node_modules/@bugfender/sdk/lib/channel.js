/*! For license information please see channel.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["@bugfender/sdk"]=t():e["@bugfender/sdk"]=t()}(self,(()=>(()=>{var e={8991:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OPEN_BROADCAST_CHANNELS=t.BroadcastChannel=void 0,t.clearNodeFolder=function(e){e=(0,i.fillOptionsWithDefaults)(e);var t=(0,o.chooseMethod)(e);return"node"===t.type?t.clearNodeFolder().then((function(){return!0})):r.PROMISE_RESOLVED_FALSE},t.enforceOptions=function(e){a=e};var r=n(6202),o=n(4632),i=n(423),s=new Set;t.OPEN_BROADCAST_CHANNELS=s;var a,c=0,u=function(e,t){var n,u;this.id=c++,s.add(this),this.name=e,a&&(t=a),this.options=(0,i.fillOptionsWithDefaults)(t),this.method=(0,o.chooseMethod)(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,u=(n=this).method.create(n.name,n.options),(0,r.isPromise)(u)?(n._prepP=u,u.then((function(e){n._state=e}))):n._state=u};function d(e,t,n){var o={time:e.method.microSeconds(),type:t,data:n};return(e._prepP?e._prepP:r.PROMISE_RESOLVED_VOID).then((function(){var t=e.method.postMessage(e._state,o);return e._uMP.add(t),t.catch().then((function(){return e._uMP.delete(t)})),t}))}function l(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function f(e,t,n){e._addEL[t].push(n),function(e){if(!e._iL&&l(e)){var t=function(t){e._addEL[t.type].forEach((function(e){var n=e.time-1e5;t.time>=n&&e.fn(t.data)}))},n=e.method.microSeconds();e._prepP?e._prepP.then((function(){e._iL=!0,e.method.onMessage(e._state,t,n)})):(e._iL=!0,e.method.onMessage(e._state,t,n))}}(e)}function h(e,t,n){e._addEL[t]=e._addEL[t].filter((function(e){return e!==n})),function(e){if(e._iL&&!l(e)){e._iL=!1;var t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}(e)}t.BroadcastChannel=u,u._pubkey=!0,u.prototype={postMessage:function(e){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed "+JSON.stringify(e));return d(this,"message",e)},postInternal:function(e){return d(this,"internal",e)},set onmessage(e){var t={time:this.method.microSeconds(),fn:e};h(this,"message",this._onML),e&&"function"==typeof e?(this._onML=t,f(this,"message",t)):this._onML=null},addEventListener:function(e,t){f(this,e,{time:this.method.microSeconds(),fn:t})},removeEventListener:function(e,t){h(this,e,this._addEL[e].find((function(e){return e.fn===t})))},close:function(){var e=this;if(!this.closed){s.delete(this),this.closed=!0;var t=this._prepP?this._prepP:r.PROMISE_RESOLVED_VOID;return this._onML=null,this._addEL.message=[],t.then((function(){return Promise.all(Array.from(e._uMP))})).then((function(){return Promise.all(e._befC.map((function(e){return e()})))})).then((function(){return e.method.close(e._state)}))}},get type(){return this.method.type},get isClosed(){return this.closed}}},8437:(e,t,n)=>{"use strict";var r=n(5585);e.exports={BroadcastChannel:r.BroadcastChannel,createLeaderElection:r.createLeaderElection,clearNodeFolder:r.clearNodeFolder,enforceOptions:r.enforceOptions,beLeader:r.beLeader}},5585:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"BroadcastChannel",{enumerable:!0,get:function(){return r.BroadcastChannel}}),Object.defineProperty(t,"OPEN_BROADCAST_CHANNELS",{enumerable:!0,get:function(){return r.OPEN_BROADCAST_CHANNELS}}),Object.defineProperty(t,"beLeader",{enumerable:!0,get:function(){return o.beLeader}}),Object.defineProperty(t,"clearNodeFolder",{enumerable:!0,get:function(){return r.clearNodeFolder}}),Object.defineProperty(t,"createLeaderElection",{enumerable:!0,get:function(){return o.createLeaderElection}}),Object.defineProperty(t,"enforceOptions",{enumerable:!0,get:function(){return r.enforceOptions}});var r=n(8991),o=n(6550)},6550:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.beLeader=a,t.createLeaderElection=function(e,t){if(e._leaderElector)throw new Error("BroadcastChannel already has a leader-elector");t=function(e,t){return e||(e={}),(e=JSON.parse(JSON.stringify(e))).fallbackInterval||(e.fallbackInterval=3e3),e.responseTime||(e.responseTime=t.method.averageResponseTime(t.options)),e}(t,e);var n=new i(e,t);return e._befC.push((function(){return n.die()})),e._leaderElector=n,n};var r=n(6202),o=n(4810),i=function(e,t){var n=this;this.broadcastChannel=e,this._options=t,this.isLeader=!1,this.hasLeader=!1,this.isDead=!1,this.token=(0,r.randomToken)(),this._aplQ=r.PROMISE_RESOLVED_VOID,this._aplQC=0,this._unl=[],this._lstns=[],this._dpL=function(){},this._dpLC=!1;var o=function(e){"leader"===e.context&&("death"===e.action&&(n.hasLeader=!1),"tell"===e.action&&(n.hasLeader=!0))};this.broadcastChannel.addEventListener("internal",o),this._lstns.push(o)};function s(e,t){var n={context:"leader",action:t,token:e.token};return e.broadcastChannel.postInternal(n)}function a(e){e.isLeader=!0,e.hasLeader=!0;var t=(0,o.add)((function(){return e.die()}));e._unl.push(t);var n=function(t){"leader"===t.context&&"apply"===t.action&&s(e,"tell"),"leader"!==t.context||"tell"!==t.action||e._dpLC||(e._dpLC=!0,e._dpL(),s(e,"tell"))};return e.broadcastChannel.addEventListener("internal",n),e._lstns.push(n),s(e,"tell")}i.prototype={applyOnce:function(e){var t=this;return this.isLeader?(0,r.sleep)(0,!0):this.isDead?(0,r.sleep)(0,!1):this._aplQC>1?this._aplQ:(this._aplQC=this._aplQC+1,this._aplQ=this._aplQ.then((function(){return function(){if(t.isLeader)return r.PROMISE_RESOLVED_TRUE;var n,o=!1,i=new Promise((function(e){n=function(){o=!0,e()}})),c=function(e){"leader"===e.context&&e.token!=t.token&&("apply"===e.action&&e.token>t.token&&n(),"tell"===e.action&&(n(),t.hasLeader=!0))};t.broadcastChannel.addEventListener("internal",c);var u=e?4*t._options.responseTime:t._options.responseTime;return s(t,"apply").then((function(){return Promise.race([(0,r.sleep)(u),i.then((function(){return Promise.reject(new Error)}))])})).then((function(){return s(t,"apply")})).then((function(){return Promise.race([(0,r.sleep)(u),i.then((function(){return Promise.reject(new Error)}))])})).catch((function(){})).then((function(){return t.broadcastChannel.removeEventListener("internal",c),!o&&a(t).then((function(){return!0}))}))}()})).then((function(){t._aplQC=t._aplQC-1})),this._aplQ.then((function(){return t.isLeader})))},awaitLeadership:function(){return this._aLP||(this._aLP=(e=this).isLeader?r.PROMISE_RESOLVED_VOID:new Promise((function(t){var n=!1;function o(){n||(n=!0,e.broadcastChannel.removeEventListener("internal",i),t(!0))}e.applyOnce().then((function(){e.isLeader&&o()})),function t(){return(0,r.sleep)(e._options.fallbackInterval).then((function(){if(!e.isDead&&!n)return e.isLeader?void o():e.applyOnce(!0).then((function(){e.isLeader?o():t()}))}))}();var i=function(t){"leader"===t.context&&"death"===t.action&&(e.hasLeader=!1,e.applyOnce().then((function(){e.isLeader&&o()})))};e.broadcastChannel.addEventListener("internal",i),e._lstns.push(i)}))),this._aLP;var e},set onduplicate(e){this._dpL=e},die:function(){var e=this;return this._lstns.forEach((function(t){return e.broadcastChannel.removeEventListener("internal",t)})),this._lstns=[],this._unl.forEach((function(e){return e.remove()})),this._unl=[],this.isLeader&&(this.hasLeader=!1,this.isLeader=!1),this.isDead=!0,s(this,"death")}}},4632:(e,t,n)=>{"use strict";n(8698),Object.defineProperty(t,"__esModule",{value:!0}),t.chooseMethod=function(e){var t=[].concat(e.methods,a).filter(Boolean);if(e.type){if("simulate"===e.type)return s.SimulateMethod;var n=t.find((function(t){return t.type===e.type}));if(n)return n;throw new Error("method-type "+e.type+" not found")}e.webWorkerSupport||(t=t.filter((function(e){return"idb"!==e.type})));var r=t.find((function(e){return e.canBeUsed()}));if(r)return r;throw new Error("No usable method found in "+JSON.stringify(a.map((function(e){return e.type}))))};var r=n(6115),o=n(9122),i=n(4924),s=n(1574),a=[r.NativeMethod,o.IndexedDBMethod,i.LocalstorageMethod]},9122:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TRANSACTION_SETTINGS=t.IndexedDBMethod=void 0,t.averageResponseTime=L,t.canBeUsed=w,t.cleanOldMessages=v,t.close=S,t.commitIndexedDBTransaction=d,t.create=g,t.createDatabase=l,t.getAllMessages=function(e){var t=e.transaction(a,"readonly",c),n=t.objectStore(a),r=[];return new Promise((function(e){n.openCursor().onsuccess=function(n){var o=n.target.result;o?(r.push(o.value),o.continue()):(d(t),e(r))}}))},t.getIdb=u,t.getMessagesHigherThan=h,t.getOldMessages=m,t.microSeconds=void 0,t.onMessage=E,t.postMessage=y,t.removeMessagesById=p,t.type=void 0,t.writeMessage=f;var r=n(6202),o=n(2151),i=n(423),s=r.microSeconds;t.microSeconds=s;var a="messages",c={durability:"relaxed"};function u(){if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof window){if(void 0!==window.mozIndexedDB)return window.mozIndexedDB;if(void 0!==window.webkitIndexedDB)return window.webkitIndexedDB;if(void 0!==window.msIndexedDB)return window.msIndexedDB}return!1}function d(e){e.commit&&e.commit()}function l(e){var t="pubkey.broadcast-channel-0-"+e,n=u().open(t);return n.onupgradeneeded=function(e){e.target.result.createObjectStore(a,{keyPath:"id",autoIncrement:!0})},new Promise((function(e,t){n.onerror=function(e){return t(e)},n.onsuccess=function(){e(n.result)}}))}function f(e,t,n){var r={uuid:t,time:(new Date).getTime(),data:n},o=e.transaction([a],"readwrite",c);return new Promise((function(e,t){o.oncomplete=function(){return e()},o.onerror=function(e){return t(e)},o.objectStore(a).add(r),d(o)}))}function h(e,t){var n=e.transaction(a,"readonly",c),r=n.objectStore(a),o=[],i=IDBKeyRange.bound(t+1,1/0);if(r.getAll){var s=r.getAll(i);return new Promise((function(e,t){s.onerror=function(e){return t(e)},s.onsuccess=function(t){e(t.target.result)}}))}return new Promise((function(e,s){var a=function(){try{return i=IDBKeyRange.bound(t+1,1/0),r.openCursor(i)}catch(e){return r.openCursor()}}();a.onerror=function(e){return s(e)},a.onsuccess=function(r){var i=r.target.result;i?i.value.id<t+1?i.continue(t+1):(o.push(i.value),i.continue()):(d(n),e(o))}}))}function p(e,t){if(e.closed)return Promise.resolve([]);var n=e.db.transaction(a,"readwrite",c).objectStore(a);return Promise.all(t.map((function(e){var t=n.delete(e);return new Promise((function(e){t.onsuccess=function(){return e()}}))})))}function m(e,t){var n=(new Date).getTime()-t,r=e.transaction(a,"readonly",c),o=r.objectStore(a),i=[];return new Promise((function(e){o.openCursor().onsuccess=function(t){var o=t.target.result;if(o){var s=o.value;s.time<n?(i.push(s),o.continue()):(d(r),e(i))}else e(i)}}))}function v(e){return m(e.db,e.options.idb.ttl).then((function(t){return p(e,t.map((function(e){return e.id})))}))}function g(e,t){return t=(0,i.fillOptionsWithDefaults)(t),l(e).then((function(n){var i={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:(0,r.randomToken)(),eMIs:new o.ObliviousSet(2*t.idb.ttl),writeBlockPromise:r.PROMISE_RESOLVED_VOID,messagesCallback:null,readQueuePromises:[],db:n};return n.onclose=function(){i.closed=!0,t.idb.onclose&&t.idb.onclose()},b(i),i}))}function b(e){e.closed||_(e).then((function(){return(0,r.sleep)(e.options.idb.fallbackInterval)})).then((function(){return b(e)}))}function _(e){return e.closed?r.PROMISE_RESOLVED_VOID:e.messagesCallback?h(e.db,e.lastCursorId).then((function(t){var n=t.filter((function(e){return!!e})).map((function(t){return t.id>e.lastCursorId&&(e.lastCursorId=t.id),t})).filter((function(t){return function(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}(t,e)})).sort((function(e,t){return e.time-t.time}));return n.forEach((function(t){e.messagesCallback&&(e.eMIs.add(t.id),e.messagesCallback(t.data))})),r.PROMISE_RESOLVED_VOID})):r.PROMISE_RESOLVED_VOID}function S(e){e.closed=!0,e.db.close()}function y(e,t){return e.writeBlockPromise=e.writeBlockPromise.then((function(){return f(e.db,e.uuid,t)})).then((function(){0===(0,r.randomInt)(0,10)&&v(e)})),e.writeBlockPromise}function E(e,t,n){e.messagesCallbackTime=n,e.messagesCallback=t,_(e)}function w(){return!!u()}function L(e){return 2*e.idb.fallbackInterval}t.TRANSACTION_SETTINGS=c,t.type="idb";var O={create:g,close:S,onMessage:E,postMessage:y,canBeUsed:w,type:"idb",averageResponseTime:L,microSeconds:s};t.IndexedDBMethod=O},4924:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LocalstorageMethod=void 0,t.addStorageEventListener=l,t.averageResponseTime=g,t.canBeUsed=v,t.close=p,t.create=h,t.getLocalStorage=c,t.microSeconds=void 0,t.onMessage=m,t.postMessage=d,t.removeStorageEventListener=f,t.storageKey=u,t.type=void 0;var r=n(2151),o=n(423),i=n(6202),s=i.microSeconds;t.microSeconds=s;var a="localstorage";function c(){var e;if("undefined"==typeof window)return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch(e){}return e}function u(e){return"pubkey.broadcastChannel-"+e}function d(e,t){return new Promise((function(n){(0,i.sleep)().then((function(){var r=u(e.channelName),o={token:(0,i.randomToken)(),time:(new Date).getTime(),data:t,uuid:e.uuid},s=JSON.stringify(o);c().setItem(r,s);var a=document.createEvent("Event");a.initEvent("storage",!0,!0),a.key=r,a.newValue=s,window.dispatchEvent(a),n()}))}))}function l(e,t){var n=u(e),r=function(e){e.key===n&&t(JSON.parse(e.newValue))};return window.addEventListener("storage",r),r}function f(e){window.removeEventListener("storage",e)}function h(e,t){if(t=(0,o.fillOptionsWithDefaults)(t),!v())throw new Error("BroadcastChannel: localstorage cannot be used");var n=(0,i.randomToken)(),s=new r.ObliviousSet(t.localstorage.removeTimeout),a={channelName:e,uuid:n,eMIs:s};return a.listener=l(e,(function(e){a.messagesCallback&&e.uuid!==n&&e.token&&!s.has(e.token)&&(e.data.time&&e.data.time<a.messagesCallbackTime||(s.add(e.token),a.messagesCallback(e.data)))})),a}function p(e){f(e.listener)}function m(e,t,n){e.messagesCallbackTime=n,e.messagesCallback=t}function v(){var e=c();if(!e)return!1;try{var t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch(e){return!1}return!0}function g(){var e=navigator.userAgent.toLowerCase();return e.includes("safari")&&!e.includes("chrome")?240:120}t.type=a;var b={create:h,close:p,onMessage:m,postMessage:d,canBeUsed:v,type:a,averageResponseTime:g,microSeconds:s};t.LocalstorageMethod=b},6115:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NativeMethod=void 0,t.averageResponseTime=l,t.canBeUsed=d,t.close=a,t.create=s,t.microSeconds=void 0,t.onMessage=u,t.postMessage=c,t.type=void 0;var r=n(6202),o=r.microSeconds;t.microSeconds=o;var i="native";function s(e){var t={messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=function(e){t.messagesCallback&&t.messagesCallback(e.data)},t}function a(e){e.bc.close(),e.subFns=[]}function c(e,t){try{return e.bc.postMessage(t,!1),r.PROMISE_RESOLVED_VOID}catch(e){return Promise.reject(e)}}function u(e,t){e.messagesCallback=t}function d(){if("undefined"==typeof window)return!1;if("function"==typeof BroadcastChannel){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}return!1}function l(){return 150}t.type=i;var f={create:s,close:a,onMessage:u,postMessage:c,canBeUsed:d,type:i,averageResponseTime:l,microSeconds:o};t.NativeMethod=f},1574:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SimulateMethod=void 0,t.averageResponseTime=l,t.canBeUsed=d,t.close=a,t.create=s,t.microSeconds=void 0,t.onMessage=u,t.postMessage=c,t.type=void 0;var r=n(6202).microSeconds;t.microSeconds=r;var o="simulate";t.type=o;var i=new Set;function s(e){var t={name:e,messagesCallback:null};return i.add(t),t}function a(e){i.delete(e)}function c(e,t){return new Promise((function(n){return setTimeout((function(){Array.from(i).filter((function(t){return t.name===e.name})).filter((function(t){return t!==e})).filter((function(e){return!!e.messagesCallback})).forEach((function(e){return e.messagesCallback(t)})),n()}),5)}))}function u(e,t){e.messagesCallback=t}function d(){return!0}function l(){return 5}var f={create:s,close:a,onMessage:u,postMessage:c,canBeUsed:d,type:o,averageResponseTime:l,microSeconds:r};t.SimulateMethod=f},423:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fillOptionsWithDefaults=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=JSON.parse(JSON.stringify(e));return void 0===t.webWorkerSupport&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=45e3),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&"function"==typeof e.idb.onclose&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=6e4),e.methods&&(t.methods=e.methods),t.node||(t.node={}),t.node.ttl||(t.node.ttl=12e4),t.node.maxParallelWrites||(t.node.maxParallelWrites=2048),void 0===t.node.useFastPath&&(t.node.useFastPath=!0),t}},6202:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PROMISE_RESOLVED_VOID=t.PROMISE_RESOLVED_TRUE=t.PROMISE_RESOLVED_FALSE=void 0,t.isPromise=function(e){return e&&"function"==typeof e.then},t.microSeconds=function(){var e=(new Date).getTime();return e===i?1e3*e+ ++s:(i=e,s=0,1e3*e)},t.randomInt=function(e,t){return Math.floor(Math.random()*(t-e+1)+e)},t.randomToken=function(){return Math.random().toString(36).substring(2)},t.sleep=function(e,t){return e||(e=0),new Promise((function(n){return setTimeout((function(){return n(t)}),e)}))};var n=Promise.resolve(!1);t.PROMISE_RESOLVED_FALSE=n;var r=Promise.resolve(!0);t.PROMISE_RESOLVED_TRUE=r;var o=Promise.resolve();t.PROMISE_RESOLVED_VOID=o;var i=0,s=0},2151:(e,t,n)=>{"use strict";n.r(t),n.d(t,{ObliviousSet:()=>r,now:()=>i,removeTooOldValues:()=>o});var r=function(){function e(e){this.ttl=e,this.map=new Map,this._to=!1}return e.prototype.has=function(e){return this.map.has(e)},e.prototype.add=function(e){var t=this;this.map.set(e,i()),this._to||(this._to=!0,setTimeout((function(){t._to=!1,o(t)}),0))},e.prototype.clear=function(){this.map.clear()},e}();function o(e){for(var t=i()-e.ttl,n=e.map[Symbol.iterator]();;){var r=n.next().value;if(!r)return;var o=r[0];if(!(r[1]<t))return;e.map.delete(o)}}function i(){return(new Date).getTime()}},4155:e=>{var t,n,r=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function s(e){if(t===setTimeout)return setTimeout(e,0);if((t===o||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(n){try{return t.call(null,e,0)}catch(n){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:o}catch(e){t=o}try{n="function"==typeof clearTimeout?clearTimeout:i}catch(e){n=i}}();var a,c=[],u=!1,d=-1;function l(){u&&a&&(u=!1,a.length?c=a.concat(c):d=-1,c.length&&f())}function f(){if(!u){var e=s(l);u=!0;for(var t=c.length;t;){for(a=c,c=[];++d<t;)a&&a[d].run();d=-1,t=c.length}a=null,u=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===i||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function h(e,t){this.fun=e,this.array=t}function p(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];c.push(new h(e,t)),1!==c.length||u||s(f)},h.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=p,r.addListener=p,r.once=p,r.off=p,r.removeListener=p,r.removeAllListeners=p,r.emit=p,r.prependListener=p,r.prependOnceListener=p,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},6110:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.MonoChannel=t.Channel=t.createBroadcastChannel=t.MessageType=void 0;const o=n(8437);var i;!function(e){e.ForceSend="force-send",e.Ping="ping",e.Pong="pong"}(i=t.MessageType||(t.MessageType={})),t.createBroadcastChannel=function(){return new o.BroadcastChannel("bf-sdk")},t.Channel=class{constructor(e,t){this.channel=e,this.logger=t,this.leader=!1,this.onForceSendCb=()=>{},this.sessionsStatus={},this.channel.onmessage=e=>this.handleMessage(e),this.elector=(0,o.createLeaderElection)(this.channel,{fallbackInterval:2e3,responseTime:1e3}),this.leaderPromise=this.elector.awaitLeadership(),this.leaderPromise.then((()=>{this.logger.log("Now I'm the leader. ðŸ’ª"),this.leader=!0}))}setCurrentSession(e){this.session=e}handleMessage(e){var t,n;switch(e.type){case i.ForceSend:this.leader&&this.onForceSendCb();break;case i.Ping:e.toSessionUUID===(null===(t=this.session)||void 0===t?void 0:t.getUUID())&&this.channel.postMessage({type:i.Pong,fromSessionUUID:e.toSessionUUID,toSessionUUID:e.fromSessionUUID});break;case i.Pong:e.toSessionUUID===(null===(n=this.session)||void 0===n?void 0:n.getUUID())&&(this.sessionsStatus[e.fromSessionUUID]=!0)}}isLeader(){return this.leader}notifyForceSend(){this.leader?this.onForceSendCb():this.channel.postMessage({type:i.ForceSend})}onForceSend(e){this.onForceSendCb=e}onHasBecomeLeader(){return this.leaderPromise}isSessionActive(e){return r(this,void 0,void 0,(function*(){const t=!!this.session;return!(t&&(!t||this.session.getUUID()!==e))||new Promise((t=>{this.sessionsStatus[e]=!1,this.channel.postMessage({type:i.Ping,fromSessionUUID:this.session.getUUID(),toSessionUUID:e}),setTimeout((()=>t(this.sessionsStatus[e])),250)}))}))}},t.MonoChannel=class{constructor(){this.onForceSendCb=()=>{},this.leaderPromise=Promise.resolve()}setCurrentSession(e){this.session=e}isLeader(){return!0}isSessionActive(e){return r(this,void 0,void 0,(function*(){const t=!!this.session;return!this.session||t&&this.session.getUUID()===e}))}notifyForceSend(){this.onForceSendCb()}onForceSend(e){this.onForceSendCb=e}onHasBecomeLeader(){return this.leaderPromise}}},4810:(e,t,n)=>{"use strict";n.r(t),n.d(t,{add:()=>c,getSize:()=>l,removeAll:()=>d,runAll:()=>u});var r=n(4155),o=n(4155),i="[object process]"===Object.prototype.toString.call(void 0!==o?o:0)?function(e){r.on("exit",(function(){return e()})),r.on("beforeExit",(function(){return e().then((function(){return r.exit()}))})),r.on("SIGINT",(function(){return e().then((function(){return r.exit()}))})),r.on("uncaughtException",(function(t){return e().then((function(){console.trace(t),r.exit(101)}))}))}:function(e){if("function"==typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope){var t=self.close.bind(self);self.close=function(){return e(),t()}}else{if("function"!=typeof window.addEventListener)return;window.addEventListener("beforeunload",(function(){e()}),!0),window.addEventListener("unload",(function(){e()}),!0)}},s=new Set,a=!1;function c(e){if(a||(a=!0,i(u)),"function"!=typeof e)throw new Error("Listener is no function");return s.add(e),{remove:function(){return s.delete(e)},run:function(){return s.delete(e),e()}}}function u(){var e=[];return s.forEach((function(t){e.push(t()),s.delete(t)})),Promise.all(e)}function d(){s.clear()}function l(){return s.size}},8698:e=>{function t(n){return e.exports=t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,t(n)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}return n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n(6110)})()));
//# sourceMappingURL=channel.js.map